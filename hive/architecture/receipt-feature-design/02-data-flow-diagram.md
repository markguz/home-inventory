# Receipt Processing - Data Flow Diagram

## Complete Pipeline Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 1: IMAGE CAPTURE                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚   User Action: Camera capture OR file upload                         â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   [Image File]                                                        â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Validation: type (JPEG/PNG), size (<10MB)                â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   [Valid Image] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 2: IMAGE PREPROCESSING (Client-Side)                â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚          â”‚
â”‚   [Valid Image] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Strip EXIF metadata                                       â”‚
â”‚        â”œâ”€â”€â”€ Resize if > 1920px width                                  â”‚
â”‚        â”œâ”€â”€â”€ Enhance contrast                                          â”‚
â”‚        â”œâ”€â”€â”€ Auto-rotate based on orientation                          â”‚
â”‚        â”œâ”€â”€â”€ Convert to grayscale                                      â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   [Preprocessed Image]                                                â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Compress to < 2MB                                         â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   [Optimized Image] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 3: TEMPORARY STORAGE (Optional)                     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚          â”‚
â”‚   [Optimized Image] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ POST /api/receipts/upload                                 â”‚
â”‚        â”‚    (multipart/form-data)                                     â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   Supabase Storage                                                    â”‚
â”‚   â””â”€ receipts-temp/{userId}/{uuid}.jpg                                â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Generate signed URL (24h expiry)                          â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   {receiptId, imageUrl, expiresAt} â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                            â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 4: OCR PROCESSING (Client-Side)                     â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚          â”‚
â”‚   [Optimized Image] + [Metadata] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Load tesseract.js (if not cached)                         â”‚
â”‚        â”œâ”€â”€â”€ Initialize worker (eng.traineddata)                       â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   Tesseract.recognize(image, {lang: 'eng'})                           â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ Progress events: 0% â†’ 100%                                â”‚
â”‚        â”‚    (loading, recognizing text, recognizing words)            â”‚
â”‚        â”‚                                                              â”‚
â”‚        â–¼                                                              â”‚
â”‚   OCR Result {                                                        â”‚
â”‚     text: "RAW TEXT...",                                              â”‚
â”‚     words: [{text, confidence, bbox}, ...],                           â”‚
â”‚     confidence: 0.85                                                  â”‚
â”‚   }                                                                   â”‚
â”‚        â”‚                                                              â”‚
â”‚        â”œâ”€â”€â”€ If confidence < 0.3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚        â”‚                                         Suggest manual entry â”‚
â”‚        â”‚                                         or server fallback   â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â–¼                                                   â”‚          â”‚
â”‚   [OCR Text Data] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚
â”‚                                                 â”‚          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 5: RECEIPT PARSING (Client-Side)         â”‚          â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚          â”‚          â”‚
â”‚   [OCR Text Data] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚          â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â”œâ”€â”€â”€ Extract merchant name (top of receipt)        â”‚          â”‚
â”‚        â”œâ”€â”€â”€ Extract date (regex patterns)                 â”‚          â”‚
â”‚        â”œâ”€â”€â”€ Extract total amount (bottom, after "TOTAL")  â”‚          â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â”œâ”€â”€â”€ Detect line items:                            â”‚          â”‚
â”‚        â”‚    â€¢ Pattern: <name> <price>                     â”‚          â”‚
â”‚        â”‚    â€¢ Pattern: <qty> x <name> @ <unit> = <total>  â”‚          â”‚
â”‚        â”‚    â€¢ Skip subtotals, tax, total lines            â”‚          â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â”œâ”€â”€â”€ Calculate confidence per item:                â”‚          â”‚
â”‚        â”‚    base = word.confidence                        â”‚          â”‚
â”‚        â”‚    + 0.15 if price detected                      â”‚          â”‚
â”‚        â”‚    + 0.10 if quantity detected                   â”‚          â”‚
â”‚        â”‚    + 0.10 if in item region                      â”‚          â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â–¼                                                   â”‚          â”‚
â”‚   Parsed Receipt {                                        â”‚          â”‚
â”‚     merchantName: "Store Name",                           â”‚          â”‚
â”‚     receiptDate: "2025-10-15",                            â”‚          â”‚
â”‚     totalAmount: 45.67,                                   â”‚          â”‚
â”‚     items: [                                              â”‚          â”‚
â”‚       {                                                   â”‚          â”‚
â”‚         name: "Product A",                                â”‚          â”‚
â”‚         quantity: 2,                                      â”‚          â”‚
â”‚         unitPrice: 5.99,                                  â”‚          â”‚
â”‚         totalPrice: 11.98,                                â”‚          â”‚
â”‚         confidence: 0.85,                                 â”‚          â”‚
â”‚         boundingBox: {x, y, w, h}                         â”‚          â”‚
â”‚       },                                                  â”‚          â”‚
â”‚       ...                                                 â”‚          â”‚
â”‚     ]                                                     â”‚          â”‚
â”‚   }                                                       â”‚          â”‚
â”‚        â”‚                                                   â”‚          â”‚
â”‚        â–¼                                                   â”‚          â”‚
â”‚   [Structured Data] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚          â”‚
â”‚                                                 â”‚          â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                  â”‚          â”‚
                                           [Manual Entry] â—€â”€â”€â”˜
                                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 6: DRAFT PERSISTENCE                     â”‚                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚                      â”‚
â”‚   [Structured Data] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ POST /api/receipts                                         â”‚
â”‚        â”‚    {                                                          â”‚
â”‚        â”‚      merchantName, receiptDate, totalAmount,                  â”‚
â”‚        â”‚      imageUrl, rawOcrText, confidence,                        â”‚
â”‚        â”‚      extractedItems: [...]                                    â”‚
â”‚        â”‚    }                                                          â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   BEGIN TRANSACTION                                                    â”‚
â”‚        â”œâ”€â”€â”€ INSERT INTO receipts (...)                                 â”‚
â”‚        â”‚    RETURNING receipt_id                                       â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ INSERT INTO extracted_items (receipt_id, ...)              â”‚
â”‚        â”‚    VALUES (...), (...), (...)  -- Batch insert                â”‚
â”‚        â”‚                                                               â”‚
â”‚   COMMIT TRANSACTION                                                   â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   {receiptId, status: "draft", extractedItems: [...]}                  â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   [Draft Receipt Saved] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                                            â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 7: USER REVIEW & EDITING                            â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚           â”‚
â”‚   [Draft Receipt] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Display: Original image + Extracted items                  â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ User interactions:                                         â”‚
â”‚        â”‚    â€¢ Edit item name, quantity, price                          â”‚
â”‚        â”‚    â€¢ Delete false positives                                   â”‚
â”‚        â”‚    â€¢ Add missed items manually                                â”‚
â”‚        â”‚    â€¢ Assign categories/locations                              â”‚
â”‚        â”‚    â€¢ Mark items as "edited" (confidence â†’ 1.0)                â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Auto-save changes (debounced):                             â”‚
â”‚        â”‚    PATCH /api/receipts/:id                                    â”‚
â”‚        â”‚    PATCH /api/receipts/:id/items/:itemId                      â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Highlight by confidence:                                   â”‚
â”‚        â”‚    ğŸŸ¢ High (0.8-1.0): Likely correct                          â”‚
â”‚        â”‚    ğŸŸ¡ Medium (0.5-0.79): Review recommended                   â”‚
â”‚        â”‚    ğŸ”´ Low (0.0-0.49): Likely needs editing                    â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Sort options:                                              â”‚
â”‚        â”‚    â€¢ By confidence (low first)                                â”‚
â”‚        â”‚    â€¢ By position (top to bottom)                              â”‚
â”‚        â”‚    â€¢ By price (high to low)                                   â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   User clicks "Confirm & Add to Inventory"                             â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   [Reviewed Items] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                             â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 8: INVENTORY CREATION                                â”‚          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚          â”‚
â”‚   [Reviewed Items] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ POST /api/receipts/:id/confirm                             â”‚
â”‚        â”‚    {                                                          â”‚
â”‚        â”‚      items: [                                                 â”‚
â”‚        â”‚        {                                                      â”‚
â”‚        â”‚          extractedItemId: "...",                              â”‚
â”‚        â”‚          name: "Product A",                                   â”‚
â”‚        â”‚          quantity: 2,                                         â”‚
â”‚        â”‚          categoryId: "...",                                   â”‚
â”‚        â”‚          locationId: "...",                                   â”‚
â”‚        â”‚          ...inventoryItemFields                               â”‚
â”‚        â”‚        },                                                     â”‚
â”‚        â”‚        ...                                                    â”‚
â”‚        â”‚      ]                                                        â”‚
â”‚        â”‚    }                                                          â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   BEGIN TRANSACTION                                                    â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ For each confirmed item:                                   â”‚
â”‚        â”‚    INSERT INTO items (                                        â”‚
â”‚        â”‚      name, quantity, category_id, location_id,                â”‚
â”‚        â”‚      receipt_id, extracted_item_id, user_id, ...              â”‚
â”‚        â”‚    ) RETURNING item_id                                        â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ UPDATE extracted_items                                     â”‚
â”‚        â”‚    SET status = 'confirmed'                                   â”‚
â”‚        â”‚    WHERE id IN (...)                                          â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ UPDATE receipts                                            â”‚
â”‚        â”‚    SET processing_status = 'confirmed',                       â”‚
â”‚        â”‚        updated_at = NOW()                                     â”‚
â”‚        â”‚    WHERE id = receipt_id                                      â”‚
â”‚        â”‚                                                               â”‚
â”‚   COMMIT TRANSACTION                                                   â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   {                                                                    â”‚
â”‚     success: true,                                                     â”‚
â”‚     createdItems: [{itemId}, ...],                                     â”‚
â”‚     receipt: {id, status: "confirmed"}                                 â”‚
â”‚   }                                                                    â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   [Inventory Items Created] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                                                            â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STAGE 9: POST-PROCESSING                                  â”‚           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                            â”‚           â”‚
â”‚   [Success Response] â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Client: Navigate to inventory view                         â”‚
â”‚        â”‚             Show success toast with item count                â”‚
â”‚        â”‚             Cache invalidation (React Query)                  â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”œâ”€â”€â”€ Server (async):                                            â”‚
â”‚        â”‚    â€¢ If user preference: Move image to archive                â”‚
â”‚        â”‚      receipts-temp/ â†’ receipts-archive/                       â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”‚    â€¢ If user preference OFF: Delete image immediately         â”‚
â”‚        â”‚      DELETE from receipts-temp/                               â”‚
â”‚        â”‚                                                               â”‚
â”‚        â”‚    â€¢ Log analytics event:                                     â”‚
â”‚        â”‚      - receipt_confirmed                                      â”‚
â”‚        â”‚      - items_count: N                                         â”‚
â”‚        â”‚      - processing_time: Xs                                    â”‚
â”‚        â”‚      - avg_confidence: 0.XX                                   â”‚
â”‚        â”‚                                                               â”‚
â”‚        â–¼                                                               â”‚
â”‚   [Complete] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                             â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                              â”‚
                                                              â–¼
                                                     User views inventory
```

## Error Handling Flows

### OCR Failure Flow
```
[Image] â†’ [OCR Processing]
             â”‚
             â”œâ”€â”€â”€ Success (confidence > 0.3) â”€â”€â†’ [Continue to Parsing]
             â”‚
             â””â”€â”€â”€ Failure/Low Confidence
                   â”‚
                   â”œâ”€â”€â”€ Show error message
                   â”‚
                   â”œâ”€â”€â”€ Options:
                   â”‚    1. Retry with different settings
                   â”‚    2. Use server-side OCR (fallback)
                   â”‚    3. Manual entry mode
                   â”‚    4. Cancel and re-capture
                   â”‚
                   â””â”€â”€â”€ User selects option â†’ [Appropriate flow]
```

### Network Failure Flow
```
[API Call] â†’ [Network Request]
               â”‚
               â”œâ”€â”€â”€ Success â†’ [Continue]
               â”‚
               â””â”€â”€â”€ Failure (timeout/5xx/no connection)
                     â”‚
                     â”œâ”€â”€â”€ Show retry dialog
                     â”‚
                     â”œâ”€â”€â”€ Save draft locally (IndexedDB)
                     â”‚
                     â””â”€â”€â”€ Auto-retry with exponential backoff
                           â”‚
                           â”œâ”€â”€â”€ Success â†’ [Continue]
                           â”‚
                           â””â”€â”€â”€ Max retries â†’ [Save locally, sync later]
```

### Validation Failure Flow
```
[User Confirmation] â†’ [Validate Items]
                        â”‚
                        â”œâ”€â”€â”€ All valid â†’ [Create Inventory Items]
                        â”‚
                        â””â”€â”€â”€ Validation errors
                              â”‚
                              â”œâ”€â”€â”€ Missing required fields (name, quantity)
                              â”œâ”€â”€â”€ Invalid values (negative quantity)
                              â”œâ”€â”€â”€ Duplicate items
                              â”‚
                              â”œâ”€â”€â”€ Highlight errors in UI
                              â”‚
                              â””â”€â”€â”€ User corrects â†’ [Re-validate]
```

## Data State Transitions

```
Receipt Status State Machine:

  [draft] â†â”€â”€â”€â”€â”€â”€â”€ Initial creation (STAGE 6)
     â”‚
     â”œâ”€â”€â”€ User edits â”€â”€â†’ [draft] (stays in draft)
     â”‚
     â”œâ”€â”€â”€ User confirms â”€â”€â†’ [processing]
     â”‚                          â”‚
     â”‚                          â”œâ”€â”€â”€ Success â”€â”€â†’ [confirmed]
     â”‚                          â”‚
     â”‚                          â””â”€â”€â”€ Error â”€â”€â†’ [failed]
     â”‚
     â””â”€â”€â”€ User deletes â”€â”€â†’ [deleted] (soft delete)

Extracted Item Status:

  [pending] â†â”€â”€â”€â”€â”€â”€â”€ Initial extraction (STAGE 5)
     â”‚
     â”œâ”€â”€â”€ User edits â”€â”€â†’ [edited]
     â”‚
     â”œâ”€â”€â”€ User deletes â”€â”€â†’ [rejected]
     â”‚
     â””â”€â”€â”€ Confirmation â”€â”€â†’ [confirmed] (+ inventory item created)
```

## Performance Optimization Points

| Stage | Optimization | Impact |
|-------|-------------|---------|
| Stage 2 | Use Canvas API offscreen | 30% faster preprocessing |
| Stage 4 | Web Worker for OCR | Non-blocking UI |
| Stage 4 | Cache tesseract data | 2s faster cold start |
| Stage 5 | Memoize parsing regex | 15% faster parsing |
| Stage 6 | Batch insert items | 50% fewer DB queries |
| Stage 8 | Transaction for atomicity | Prevent partial saves |
| All | React Query caching | Instant UI updates |

## Data Volume Estimates

| Data Type | Size | Retention | Storage |
|-----------|------|-----------|---------|
| Image (original) | 2-5 MB | 24 hours | Temp bucket |
| Image (archived) | 0.5-1 MB | 90 days (opt-in) | Archive bucket |
| Receipt metadata | 1-2 KB | Indefinite | Database |
| Extracted items | 0.5-1 KB each | Indefinite | Database |
| OCR raw text | 2-10 KB | Indefinite (debug) | Database |

**Example**: 1000 users Ã— 10 receipts/month Ã— 2 MB = 20 GB/month temporary storage (auto-deleted after 24h)
